<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SVG → PNG (пакетная конвертация, офлайн)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root { --bg:#0b0f14; --panel:#111824; --muted:#8aa0b6; --acc:#7cdbff; --ok:#5ee3a1; --warn:#ffd166; --err:#ff6b6b; }
    * { box-sizing: border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(180deg,#0b0f14,#0a0e13); color:#e6eef7; }
    .wrap{ max-width:1000px; margin:40px auto; padding:24px; }
    h1{ font-size:28px; margin:0 0 8px; letter-spacing:.2px; }
    p.sub{ margin:0 0 24px; color:var(--muted); }
    .grid{ display:grid; grid-template-columns:1fr 360px; gap:20px; }
    .card{ background:var(--panel); border:1px solid #1c2940; border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.35); }
    .drop{ border:2px dashed #2a3a57; border-radius:14px; padding:24px; text-align:center; transition:.2s; cursor:pointer; }
    .drop.drag{ border-color:var(--acc); background:rgba(124,219,255,.06); }
    .drop input{ display:none; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; background:#0f1624; border:1px solid #1f2b45; color:#cfe7ff; }
    .list{ max-height:360px; overflow:auto; margin-top:12px; }
    .row{ display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; padding:8px 10px; border-radius:12px; border:1px solid #1c2940; background:#0f1624; margin-bottom:8px; }
    .row .badge{ font-size:12px; color:#9fb3c8; background:#0b1422; border:1px solid #1f2b45; padding:4px 8px; border-radius:999px; }
    label{ display:block; font-weight:600; font-size:13px; margin:12px 0 6px; color:#cfe7ff; }
    .ctrl{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #1f2b45; background:#0f1624; color:#e6eef7; }
    .rowbtn,.btn{ appearance:none; border:0; background:#183557; color:#d8ecff; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.18s; }
    .rowbtn:hover,.btn:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.25); }
    .btn.primary{ background:linear-gradient(135deg,#1b7bd6,#3ac7ff); color:#06101a; }
    .btn.ghost{ background:#0f1624; border:1px solid #1f2b45; }
    .hint{ font-size:12px; color:#9fb3c8; margin-top:6px; }
    .footer{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .ok{ color:var(--ok); }
    .warn{ color:var(--warn); }
    .err{ color:var(--err); }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SVG → PNG (пакетная конвертация)</h1>
    <p class="sub">Заточено под иконки (Papirus/Theme Park). Работает полностью офлайн в браузере. Ничего никуда не загружается.</p>

    <div class="grid">
      <!-- Left: files -->
      <div class="card">
        <div id="drop" class="drop">
          <input id="fileInp" type="file" accept=".svg" multiple>
          <div class="pill">Перетащи сюда SVG или нажми, чтобы выбрать</div>
          <div class="hint" style="margin-top:8px">Поддерживается множественный выбор • Название сохранится • Можно до нескольких сотен файлов</div>
        </div>

        <div class="list" id="fileList"></div>
      </div>

      <!-- Right: settings -->
      <div class="card">
        <div>
          <label for="size">Размер PNG (px)</label>
          <select id="size" class="ctrl">
            <option value="192">192 (рекомендовано для Samsung Theme Park)</option>
            <option value="256">256</option>
            <option value="384">384</option>
            <option value="512">512</option>
            <option value="custom">Свой размер…</option>
          </select>
          <input id="customSize" class="ctrl" type="number" min="16" max="2048" step="1" placeholder="Введите размер, например 224" style="display:none; margin-top:8px">

          <label for="bg">Фон</label>
          <select id="bg" class="ctrl">
            <option value="transparent">Прозрачный</option>
            <option value="#ffffff">Белый</option>
            <option value="#000000">Чёрный</option>
          </select>

          <label for="padding">Отступ внутри (padding)</label>
          <input id="padding" class="ctrl" type="number" min="0" max="128" value="0">
          <div class="hint">0 = без отступов. Для «воздуха» вокруг иконки поставь 8–16.</div>

          <label for="scale">Масштаб SVG</label>
          <select id="scale" class="ctrl">
            <option value="fit">Вписать (сохранить пропорции)</option>
            <option value="fill">Заполнить (обрежет края)</option>
          </select>

          <label>Имена файлов</label>
          <div style="display:flex; gap:8px;">
            <input id="prefix" class="ctrl" placeholder="Префикс (необязательно)" style="flex:1">
            <input id="suffix" class="ctrl" placeholder="Суффикс (необязательно)" style="flex:1">
          </div>

          <div class="footer">
            <button id="convertAll" class="btn primary">Конвертировать и скачать ZIP</button>
            <button id="clear" class="btn ghost">Очистить список</button>
          </div>
          <div class="hint">Для скачивания отдельных PNG нажимай кнопку у строки файла.</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const fileInp = document.getElementById('fileInp');
  const drop = document.getElementById('drop');
  const list = document.getElementById('fileList');
  const sizeSel = document.getElementById('size');
  const customSizeInp = document.getElementById('customSize');
  const bgSel = document.getElementById('bg');
  const padInp = document.getElementById('padding');
  const scaleSel = document.getElementById('scale');
  const prefixInp = document.getElementById('prefix');
  const suffixInp = document.getElementById('suffix');
  const convertAllBtn = document.getElementById('convertAll');
  const clearBtn = document.getElementById('clear');

  let files = [];

  const getTargetSize = () => {
    const val = sizeSel.value;
    if (val === 'custom') {
      const n = parseInt(customSizeInp.value, 10);
      return Number.isFinite(n) && n > 0 ? n : 192;
    }
    return parseInt(val, 10);
  };

  sizeSel.addEventListener('change', () => {
    customSizeInp.style.display = sizeSel.value === 'custom' ? 'block' : 'none';
  });

  const human = (n) => `${(n/1024).toFixed(1)} KB`;

  const rowEl = (file, idx) => {
    const r = document.createElement('div');
    r.className = 'row';
    const left = document.createElement('div');
    left.className = 'badge';
    left.textContent = `${idx+1}`;
    const mid = document.createElement('div');
    mid.innerHTML = `<div style="font-weight:600">${file.name}</div><div class="hint">${human(file.size)}</div>`;
    const right = document.createElement('div');
    const btn = document.createElement('button');
    btn.className = 'rowbtn';
    btn.textContent = 'PNG';
    btn.addEventListener('click', async () => {
      const blob = await convertOne(file);
      saveAs(blob, outputName(file.name));
    });
    right.appendChild(btn);
    r.append(left, mid, right);
    return r;
  };

  const renderList = () => {
    list.innerHTML = '';
    files.forEach((f, i) => list.appendChild(rowEl(f, i)));
  };

  const outputName = (name) => {
    const base = name.replace(/\.svg$/i, '');
    const prefix = (prefixInp.value || '').trim();
    const suffix = (suffixInp.value || '').trim();
    const safe = (s) => s.replace(/[^a-zA-Z0-9._-]+/g, '-');
    return `${safe(prefix)}${safe(base)}${safe(suffix)}.png`.replace(/^\-+/, '');
  };

  const readFileText = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = (e) => rej(e);
    fr.readAsText(file);
  });

  const rasterizeSVG = async (svgText, outSize, bg, mode, padding) => {
    // Inject width/height if missing to improve rendering consistency
    let svg = svgText.replace(/<svg(\s|>)/i, (m) => m);
    // Create blob URL
    const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(svgBlob);
    try {
      const img = await createImageBitmap(svgBlob).catch(async () => {
        const image = new Image();
        image.decoding = 'async';
        image.crossOrigin = 'anonymous';
        image.src = url;
        await image.decode();
        return image;
      });

      // Use natural dimensions if available
      const srcW = img.width || outSize;
      const srcH = img.height || outSize;

      const pad = Math.max(0, parseInt(padding, 10) || 0);
      const canvas = document.createElement('canvas');
      canvas.width = outSize;
      canvas.height = outSize;
      const ctx = canvas.getContext('2d');

      if (bg !== 'transparent') {
        ctx.fillStyle = bg;
        ctx.fillRect(0,0,canvas.width,canvas.height);
      } else {
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }

      const box = { x: pad, y: pad, w: outSize - pad*2, h: outSize - pad*2 };

      let dw = box.w, dh = box.h, dx = box.x, dy = box.y;
      const aspect = srcW / srcH;
      const boxAspect = box.w / box.h;

      if (mode === 'fit') {
        if (aspect > boxAspect) { // limit by width
          dh = box.w / aspect;
          dy = box.y + (box.h - dh) / 2;
        } else { // limit by height
          dw = box.h * aspect;
          dx = box.x + (box.w - dw) / 2;
        }
      } else { // fill
        if (aspect > boxAspect) { // need taller
          dw = box.h * aspect;
          dx = box.x + (box.w - dw) / 2;
          dh = box.h; dy = box.y;
        } else {
          dh = box.w / aspect;
          dy = box.y + (box.h - dh) / 2;
          dw = box.w; dx = box.x;
        }
      }

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, dx, dy, dw, dh);

      const blob = await new Promise((res) => canvas.toBlob(res, 'image/png'));
      return blob;
    } finally {
      URL.revokeObjectURL(url);
    }
  };

  const convertOne = async (file) => {
    const txt = await readFileText(file);
    const size = getTargetSize();
    const bg = bgSel.value;
    const mode = scaleSel.value;
    const pad = parseInt(padInp.value, 10) || 0;
    return rasterizeSVG(txt, size, bg, mode, pad);
  };

  // DnD / select
  const addFiles = (flist) => {
    const arr = Array.from(flist).filter(f => /\.svg$/i.test(f.name));
    files = files.concat(arr);
    renderList();
  };

  drop.addEventListener('click', () => fileInp.click());

  ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => {
    e.preventDefault(); e.stopPropagation(); drop.classList.add('drag');
  }));
  ;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => {
    e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag');
  }));
  drop.addEventListener('drop', (e) => addFiles(e.dataTransfer.files));
  fileInp.addEventListener('change', (e) => addFiles(e.target.files));

  clearBtn.addEventListener('click', () => { files = []; renderList(); fileInp.value=''; });

  convertAllBtn.addEventListener('click', async () => {
    if (!files.length) { alert('Добавь SVG-файлы в список.'); return; }
    const zip = new JSZip();
    const size = getTargetSize();
    const bg = bgSel.value;
    const mode = scaleSel.value;
    const pad = parseInt(padInp.value, 10) || 0;

    // Process sequentially to reduce memory spikes on mobile
    for (let i = 0; i < files.length; i++) {
      const f = files[i];
      try {
        const txt = await readFileText(f);
        const blob = await rasterizeSVG(txt, size, bg, mode, pad);
        zip.file(outputName(f.name), blob);
        list.children[i].style.outline = '2px solid var(--ok)';
      } catch (e) {
        console.error('Ошибка конвертации', f.name, e);
        list.children[i].style.outline = '2px solid var(--err)';
      }
    }

    const content = await zip.generateAsync({ type: 'blob' });
    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    saveAs(content, `svg2png_${size}px_${bg === 'transparent' ? 'transparent' : 'bg' }_${stamp}.zip`);
  });
})();
</script>
</body>
</html>
